#ifndef _NVME
#define _NVME
#define NVME_DRIVE_PCIE_CLASS (0x01)
#define NVME_DRIVE_PCIE_SUBCLASS (0x08)
#define NVME_DRIVE_PCIE_PROGIF (0x02)
#define NVME_DOORBELL_LIST_OFFSET (0x1000)
struct nvme_capabilities_register{
	volatile uint64_t max_queue_entry_count:16;
	volatile uint64_t contiguous_queues_required:1;
	volatile uint64_t arbitration_mechanism_supported:2;
	volatile uint64_t reserved0:5;
	volatile uint64_t timeout:8;
	volatile uint64_t doorbell_stride:4;
	volatile uint64_t subsystem_reset_supported:1;
	volatile uint64_t command_sets_supporetd:8;
	volatile uint64_t boot_partition_support:1;
	volatile uint64_t controller_power_support:2;
	volatile uint64_t memory_page_size_minimum:4;
	volatile uint64_t memory_page_size_maximum:4;
	volatile uint64_t persistent_memory_region_supported:1;
	volatile uint64_t controller_memory_buffer_supported:1;
	volatile uint64_t reserved1:6;
}__attribute__((packed));
struct nvme_version_register{
	volatile uint32_t tertiary_version:8;
	volatile uint32_t minor_version:8;
	volatile uint32_t major_version:16;
}__attribute__((packed));
struct nvme_controller_config{
	volatile uint32_t enable:1;
	volatile uint32_t reserved0:3;
	volatile uint32_t io_cmd_set_selected:3;
	volatile uint32_t memory_page_size:4;
	volatile uint32_t arbitration_mechanism_selected:3;
	volatile uint32_t shutdown_notification:2;
	volatile uint32_t io_submission_queue_entry_size:4;
	volatile uint32_t io_completion_queue_entry_size:4;
	volatile uint32_t reserved1:8;
}__attribuute__((packed));
struct nvme_controller_status{
	volatile uint32_t ready:1;
	volatile uint32_t controller_fatal_status:1;
	volatile uint32_t shutdown_status:2;
	volatile uint32_t subsystem_reset_occured:1;
	volatile uint32_t processing_paused:1;
	volatile uint32_t reserved0:26;
}__attribute__((packed));
struct nvme_admin_queue_attribs{
	uint32_t admin_submission_queue_size:12;
	uint32_t reserved0:4;
	uint32_t admin_completion_queue_size:12;
	uint32_t reserved1:4;
}__attribute__((packed));
struct nvme_controller_memory_buffer_status{
	uint32_t controller_base_address_invalid:1;
	uint32_t reserved0:31;
}__attribute__((packed));
struct nvme_base_mmio{
	volatile struct nvme_capabilities_register capabilities;
	volatile struct nvme_version_register version;
	volatile uint32_t interrupt_mask_set;
	volatile uint32_t interrupt_mask_clear;
	volatile struct nvme_controller_config controller_config;
	volatile uint32_t reserved0;
	volatile struct nvme_controller_status controller_status;
	volatile uint32_t reset_subsystem;
	volatile uint32_t admin_queue_attribs;
	volatile uint64_t admin_submission_queue_base;
	volatile uint64_t admin_completion_queue_base;
	volatile uint32_t controller_buffer_base;
	volatile uint32_t controller_buffer_size;
	volatile uint32_t bootPartitionInfo;
	volatile uint32_t bootPartitionReadSelect;
	volatile uint64_t boot_partition_buffer_base;
	volatile uint64_t controller_buffer_space_ctrl;
	volatile uint32_t controller_buffer_status;
}__attribute__((packed));
struct nvme_drive_desc{
	struct pcie_location location;
	volatile struct nvme_base_mmio* pBaseRegisters;
	uint64_t pBaseRegisters_phys;
	volatile uint32_t* pDoorbellBase;
};
int nvme_driver_init(void);
int nvme_drive_init(struct pcie_location location);
int nvme_drive_deinit(struct pcie_location location);
int nvme_subsystem_function_register(struct pcie_location location);
int nvme_subsystem_function_unregister(struct pcie_location location);
#endif
